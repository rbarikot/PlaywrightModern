name: Playwright Tests + SonarQube

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for SonarQube

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    # Create .env file from secrets
    - name: Create .env file
      run: |
        echo "TEAMS_WEBHOOK_URL=${{ secrets.TEAMS_WEBHOOK_URL }}" >> .env

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    # Create test result directories
    - name: Create directories
      run: |
        mkdir -p testResult/smartreport
        mkdir -p testResult/htmlreport
        mkdir -p coverage

    # Run Playwright tests
    - name: Run Playwright Tests
      run: npx playwright test
      continue-on-error: true
      env:
        CI: true
        TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}

    # Generate coverage report (if you have instrumented code)
    - name: Generate Coverage Report
      if: always()
      run: |
        npm install --save-dev c8
        npx c8 --reporter=lcov --reporter=text --report-dir=coverage npx playwright test || true
      continue-on-error: true

    # SonarQube Scan
    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v2
      env:
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    # Quality Gate
    - name: SonarQube Quality Gate
      uses: SonarSource/sonarqube-quality-gate-action@v1
      timeout-minutes: 5
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true

    # Upload Smart Report
    - name: Upload Smart Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smart-report
        path: testResult/smartreport/
        retention-days: 30

    # Upload HTML Report
    - name: Upload HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: html-report
        path: testResult/htmlreport/
        retention-days: 30

    # Upload Playwright Report
    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    # Upload Coverage Report
    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

    # Upload Test Results
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results/
        retention-days: 30